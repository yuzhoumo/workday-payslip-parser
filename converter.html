<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workday Payslip Web Converter</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>
  <h1>Workday Excel Payslips Converter</h1>
  <p>All files are processed locally in your browser. Use Shift+Click to select multiple.</p>
  <input type="file" id="files" multiple accept=".xlsx" />

  <br><br>

  <p id="loading-message">loading converter code... please wait...</p>

  <div id="loading-button-wrapper" style="display:none">
    <button id="convert-csv-btn">Convert to CSV</button>
    <button id="convert-json-btn">Convert to JSON</button>
  </div>

  <br>

  <a id="download-link" href=''></a>
  <pre id="output-content"></pre>

  <script>
    async function initPyodide() {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");

      await pyodide.runPythonAsync(`
          import micropip
          await micropip.install('openpyxl')

          import csv
          import json
          from io import BytesIO, StringIO, TextIOWrapper
          from datetime import datetime
          from openpyxl import load_workbook
          from openpyxl.worksheet.worksheet import Worksheet
          from enum import Enum
          from typing import Any


          class PayslipSection:
              SINGLE = 'SINGLE'
              GRID = 'GRID'
              SECTIONS = {
                  'Company Information': SINGLE,
                  'Payslip Information': SINGLE,
                  'Current and YTD Totals': GRID,
                  'Earnings': GRID,
                  'Employee Taxes': GRID,
                  'Pre Tax Deductions': GRID,
                  'Post Tax Deductions': GRID,
                  'Employer Paid Benefits': GRID,
                  'Taxable Wages': GRID,
                  'Withholding': GRID,
                  'Payment Information': GRID,
              }


          class OutputFormat(Enum):
              JSON = 'json'
              CSV = 'csv'


          def parse_table_single_row(ws: Worksheet, start_row: Any, output: dict,
                                     fmt: OutputFormat = OutputFormat.JSON):
              key_prefix = ws.cell(start_row, 1).value
              label_row = start_row + 1
              data_row = start_row + 2
              col = 1

              if fmt == OutputFormat.JSON:
                  output[key_prefix] = {}

              while ws.cell(label_row, col).value is not None:
                  key_suffix = ws.cell(label_row, col).value
                  val = ws.cell(data_row, col).value
                  col += 1

                  if fmt == OutputFormat.JSON:
                      output[key_prefix][key_suffix] = val
                  else:
                      key = f'{key_prefix} - {key_suffix}'
                      output[key] = val


          def parse_table_grid(ws: Worksheet, start_row: Any, output: dict,
                               fmt: OutputFormat = OutputFormat.JSON):

              key_prefix = ws.cell(start_row, 1).value
              label_row = start_row + 1
              data_row = start_row + 2

              if fmt == OutputFormat.JSON:
                  output[key_prefix] = []

              last_row = ws.max_row
              while ws.cell(data_row, 1).value not in PayslipSection.SECTIONS and data_row <= last_row:
                  col = 2
                  key_suffix_1 = ws.cell(data_row, 1).value

                  if fmt == OutputFormat.JSON:
                      output[key_prefix].append({})

                  while ws.cell(label_row, col).value is not None:
                      key_suffix_2 = ws.cell(label_row, col).value
                      val = ws.cell(data_row, col).value
                      col += 1

                      if fmt == OutputFormat.JSON:
                          output[key_prefix][-1]['Description'] = key_suffix_1
                          output[key_prefix][-1][key_suffix_2] = val
                      else:
                          key = f'{key_prefix} - {key_suffix_1} - {key_suffix_2}'
                          output[key] = val
                  data_row += 1


          def parse_payslip_to_csv(file_bytes):
              file = BytesIO(file_bytes)
              wb = load_workbook(file)
              ws = wb.active

              payslip_data = {}
              for cell in ws['A']:
                  match PayslipSection.SECTIONS.get(cell.value):
                      case PayslipSection.SINGLE:
                          parse_table_single_row(ws, cell.row, payslip_data, OutputFormat.CSV)
                      case PayslipSection.GRID:
                          parse_table_grid(ws, cell.row, payslip_data, OutputFormat.CSV)

              output = StringIO()
              writer = csv.DictWriter(output, fieldnames=list(payslip_data.keys()))
              writer.writeheader()
              writer.writerow(payslip_data)

              return output.getvalue()


          def parse_payslip_to_json(file_bytes):
              file = BytesIO(file_bytes)
              wb = load_workbook(file)
              ws = wb.active

              payslip_data = {}
              for cell in ws['A']:
                  match PayslipSection.SECTIONS.get(cell.value):
                      case PayslipSection.SINGLE:
                          parse_table_single_row(ws, cell.row, payslip_data, OutputFormat.JSON)
                      case PayslipSection.GRID:
                          parse_table_grid(ws, cell.row, payslip_data, OutputFormat.JSON)

              return json.dumps(payslip_data, indent=2)
      `);

      // expose the json parsing function globally
      window.js_parse_json = async function(fileBytes) {
        window.py_file_bytes = pyodide.toPy(fileBytes);
        return await pyodide.runPythonAsync(`
            from js import py_file_bytes
            parse_payslip_to_json(py_file_bytes)
        `);
      };

      // expose the csv parsing function globally
      window.js_parse_csv = async function(fileBytes) {
        window.py_file_bytes = pyodide.toPy(fileBytes);
        return await pyodide.runPythonAsync(`
            from js import py_file_bytes
            parse_payslip_to_csv(py_file_bytes)
        `);
      };
    }

    // set processing message and clear the download link
    function setProcessing() {
      const out = document.getElementById("output-content");
      out.textContent = "⏳ processing…";
      const link = document.getElementById("download-link");
      link.textContent = ""
    }

    // set the output content and download link
    function setContent(content, type, filename) {
      const blob = new Blob([content], { type: type });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("download-link");

      link.href = url;
      link.download = filename;
      link.textContent = "Click here to download the converted file"

      const out = document.getElementById("output-content");
      out.textContent = content;
    }

    // initialize csv conversion button
    document.getElementById("convert-csv-btn").onclick = async () => {
      let all = [];
      setProcessing();
      for (let file of document.getElementById("files").files) {
        const buf = await file.arrayBuffer();
        const csv = await window.js_parse_csv(new Uint8Array(buf));
        all.push(csv.trim());
      }
      setContent(all.join('\n'), "text/csv", "payslips.csv");
    };

    // initialize json conversion button
    document.getElementById("convert-json-btn").onclick = async () => {
      let all = { Payslips: [] };
      setProcessing();
      for (let file of document.getElementById("files").files) {
        const buf = await file.arrayBuffer();
        const json = await window.js_parse_json(new Uint8Array(buf));
        all.Payslips.push(JSON.parse(json));
      }
      setContent(JSON.stringify(all, null, 2), "text/json", "payslips.json");
    };

    // initialize pyodide
    initPyodide().then(() => {
      document.getElementById("loading-message").remove();
      document.getElementById("loading-button-wrapper").style = "";
    });
  </script>
</body>
</html>
